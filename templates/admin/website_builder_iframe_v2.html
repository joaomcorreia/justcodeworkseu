{% extends 'admin/base.html' %}
{% load static %}

{% block title %}AI Website Builder - JustCodeWorks Admin{% endblock %}

{% block extra_css %}
<style>
.builder-container {
    height: calc(100vh - 250px);
    min-height: 500px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    position: relative;
    margin: 0;
}

.builder-iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: white;
    display: block;
}

.builder-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px 8px 0 0;
}

.builder-tabs {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
}

.builder-tab {
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
}

.builder-tab:hover,
.builder-tab.active {
    background: rgba(255,255,255,0.3);
    color: white;
    text-decoration: none;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.refresh-btn {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s;
}

.refresh-btn:hover {
    background: rgba(255,255,255,0.3);
}

.error-message {
    text-align: center;
    padding: 2rem;
    color: #666;
}
</style>
{% endblock %}

{% block content %}
<div class="builder-container">
    <div class="builder-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0"><i class="fas fa-magic me-2"></i>AI Website Builder</h4>
                <p class="mb-0">Build professional websites with Clippy 2.0</p>
            </div>
            <div>
                <button class="refresh-btn" onclick="refreshBuilder()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <a href="/website-builder/" target="_blank" class="refresh-btn ms-2">
                    <i class="fas fa-external-link-alt me-1"></i>Open in New Tab
                </a>
            </div>
        </div>
        
        <div class="builder-tabs">
            <a href="#" class="builder-tab active" onclick="loadBuilderPage('dashboard', this)">
                <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
            <a href="#" class="builder-tab" onclick="loadBuilderPage('new', this)">
                <i class="fas fa-plus me-1"></i>New Website
            </a>
            <a href="#" class="builder-tab" onclick="loadBuilderPage('templates', this)">
                <i class="fas fa-palette me-1"></i>Templates
            </a>
            <a href="#" class="builder-tab" onclick="loadBuilderPage('projects', this)">
                <i class="fas fa-folder me-1"></i>My Projects
            </a>
        </div>
    </div>
    
    <div style="position: relative; height: calc(100% - 140px);">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
        <iframe id="builderFrame" 
                class="builder-iframe" 
                src="/website-builder/"
                onload="hideLoading()"
                onerror="handleIframeError()">
        </iframe>
    </div>
</div>

<script>
let currentBuilderUrl = "/website-builder/";

function handleIframeError() {
    document.getElementById('loadingOverlay').innerHTML = `
        <div class="error-message">
            <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
            <h5>Website Builder Loading...</h5>
            <p class="text-muted">If this takes too long, try opening in a new tab.</p>
            <div class="mt-3">
                <button class="btn btn-primary me-2" onclick="refreshBuilder()">
                    <i class="fas fa-sync-alt me-1"></i>Try Again
                </button>
                <a href="/website-builder/" target="_blank" class="btn btn-outline-primary">
                    <i class="fas fa-external-link-alt me-1"></i>Open in New Tab
                </a>
            </div>
        </div>
    `;
}

function loadBuilderPage(page, element) {
    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('loadingOverlay').innerHTML = '<div class="loading-spinner"></div>';
    
    // Update active tab
    document.querySelectorAll('.builder-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    element.classList.add('active');
    
    // Determine URL based on page
    let url;
    switch(page) {
        case 'dashboard':
            url = "/website-builder/";
            break;
        case 'new':
            url = "/website-builder/new/";
            break;
        case 'templates':
            url = "/website-builder/templates/";
            break;
        case 'projects':
            url = "/website-builder/projects/";
            break;
        default:
            url = "/website-builder/";
    }
    
    // Load new page in iframe
    currentBuilderUrl = url;
    document.getElementById('builderFrame').src = url;
}

function refreshBuilder() {
    document.getElementById('loadingOverlay').style.display = 'flex';
    document.getElementById('loadingOverlay').innerHTML = '<div class="loading-spinner"></div>';
    
    const iframe = document.getElementById('builderFrame');
    iframe.src = iframe.src; // Reload current URL
}

function hideLoading() {
    setTimeout(() => {
        document.getElementById('loadingOverlay').style.display = 'none';
    }, 500); // Small delay to ensure content is loaded
}

// Handle iframe navigation and resize
window.addEventListener('message', function(event) {
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'builderNavigation') {
        currentBuilderUrl = event.data.url;
        
        // Update active tab based on current page
        const tabs = document.querySelectorAll('.builder-tab');
        tabs.forEach(tab => tab.classList.remove('active'));
        
        if (event.data.url.includes('/new/')) {
            tabs[1].classList.add('active'); // New Website tab
        } else if (event.data.url.includes('/templates/')) {
            tabs[2].classList.add('active'); // Templates tab
        } else if (event.data.url.includes('/projects/')) {
            tabs[3].classList.add('active'); // Projects tab
        } else {
            tabs[0].classList.add('active'); // Dashboard tab
        }
    }
    
    // Handle iframe height adjustments
    if (event.data.type === 'resizeIframe') {
        const iframe = document.getElementById('builderFrame');
        if (event.data.height) {
            iframe.style.height = event.data.height + 'px';
        }
    }
});

// Auto-hide loading after 10 seconds as fallback
setTimeout(() => {
    if (document.getElementById('loadingOverlay').style.display !== 'none') {
        hideLoading();
    }
}, 10000);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Small delay before showing content
    setTimeout(hideLoading, 1000);
});
</script>
{% endblock %}